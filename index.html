<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* === GLOBAL === */
body {
  font-family:"Segoe UI", Tahoma, sans-serif;
  background:linear-gradient(135deg,#6a11cb,#2575fc);
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
  color:#333;
}
.container {
  width:100%;
  max-width:950px;
  background:#fff;
  padding:30px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  animation:fadeIn 0.8s ease-in-out;
}
h2 {
  text-align:center;
  color:#6a11cb;
  margin-bottom:20px;
}
h3 {
  color:#2575fc;
  text-align:center;
  margin-bottom:15px;
}
input {
  width:100%;
  max-width:400px;
  padding:12px;
  margin:8px auto;
  border:1px solid #ddd;
  border-radius:10px;
  display:block;
  font-size:15px;
  transition:0.2s;
}
input:focus {
  outline:none;
  border-color:#6a11cb;
  box-shadow:0 0 5px rgba(106,17,203,0.5);
}
button {
  padding:10px 18px;
  margin:5px;
  border:none;
  border-radius:10px;
  font-size:15px;
  font-weight:bold;
  cursor:pointer;
  transition:all 0.3s ease;
  box-shadow:0 4px 8px rgba(0,0,0,0.15);
}
.btn-primary {
  background:linear-gradient(135deg,#2575fc,#6a11cb);
  color:#fff;
}
.btn-primary:hover { transform:translateY(-2px) scale(1.05); }
.btn-danger {
  background:#ff4d4d;
  color:#fff;
}
.btn-danger:hover { background:#e03b3b; transform:scale(1.05); }
a { color:#2575fc; cursor:pointer; text-decoration:none; }
a:hover { text-decoration:underline; }
.page { display:none; }
.active { display:block; }

/* === CARD GRID === */
.card-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
  margin:15px 0;
}
.card {
  background:#f8f9ff;
  padding:20px;
  border-radius:15px;
  text-align:center;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
  transition:0.3s;
}
.card:hover {
  transform:translateY(-5px);
  box-shadow:0 8px 20px rgba(0,0,0,0.2);
}
.card span {
  font-size:18px;
  font-weight:bold;
  color:#2575fc;
  display:block;
  margin-top:8px;
}
canvas {
  background:#fff;
  border-radius:12px;
  padding:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
  margin-top:20px;
  width:100% !important;
  height:auto !important;
}
.btn-group { text-align:center; margin-top:20px; }
.error { color:red; font-size:13px; text-align:center; margin-bottom:8px; }
.footer { margin-top:20px; font-size:13px; color:#fff; text-align:center; }

/* === ANIMASI === */
@keyframes fadeIn {
  from { opacity:0; transform:translateY(-20px); }
  to { opacity:1; transform:translateY(0); }
}

/* === RESPONSIVE === */
@media (max-width:600px){
  .container { padding:20px; }
  h2 { font-size:1.6rem; }
  h3 { font-size:1.2rem; }
  button { font-size:14px; padding:8px 14px; }
}
</style>
</head>
<body>
<div class="container">
  <h2 id="controllerTitle">âš¡ IoT Dashboard</h2>

  <!-- REGISTER -->
  <div id="registerPage" class="page">
    <h3>Daftar Akun</h3>
    <input type="text" id="regEmail" placeholder="Email">
    <div id="regEmailError" class="error"></div>
    <input type="password" id="regPassword" placeholder="Password">
    <input type="text" id="regToken" placeholder="Token Panel">
    <input type="text" id="regIbu" placeholder="Nama Ibu Kandung">
    <div style="text-align:center;">
      <button class="btn-primary" onclick="registerUser()">Daftar</button>
    </div>
    <p style="text-align:center;">Sudah punya akun? <a onclick="showPage('loginPage')">Login</a></p>
  </div>

  <!-- LOGIN -->
  <div id="loginPage" class="page active">
    <h3>Login</h3>
    <input type="text" id="logEmail" placeholder="Email">
    <input type="password" id="logPassword" placeholder="Password">
    <div style="text-align:center;">
      <button class="btn-primary" onclick="loginUser()">Login</button>
    </div>
    <p style="text-align:center;">Belum punya akun? <a onclick="showPage('registerPage')">Daftar</a></p>
    <p style="text-align:center;"><a onclick="forgotPassword()">Lupa Password?</a></p>
  </div>

  <!-- PANEL -->
  <div id="panelPage" class="page">
    <h3 id="panelTitle">Panel IoT</h3>
    <p id="panelInfo" style="text-align:center;"></p>

    <div class="card-grid">
      <div class="card">Voltage<span id="voltageVal">0</span> V</div>
      <div class="card">Ampere<span id="ampereVal">0</span> A</div>
    </div>

    <h3 id="userListTitle" style="display:none;">Pengguna Token Ini</h3>
    <div id="userList" class="card-grid"></div>

    <canvas id="voltageChart"></canvas>
    <canvas id="ampereChart"></canvas>

    <div class="btn-group">
      <button id="btnOn" class="btn-primary" onclick="sendCommand('ON')">ðŸ”µ ON</button>
      <button id="btnOff" class="btn-primary" onclick="sendCommand('OFF')">âšª OFF</button>
      <button class="btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">Pembuat: miftahuddin wardani</div>
</div>

<script>
/* === FIREBASE CONFIG === */
const firebaseConfig = {
  databaseURL:"https://esp32-3a6dd-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* === VARIABEL === */
let currentUser=null, currentToken=null, isAdmin=false;
let voltageChart=null, ampereChart=null;
let voltageData=[], voltageLabels=[], ampereData=[], ampereLabels=[];
let panelRef=null;

/* === PAGE SWITCH === */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* === VALIDASI EMAIL === */
function isValidEmail(email){ return email.includes('@') && email.includes('.'); }

/* === REGISTER === */
function registerUser(){
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPassword').value.trim();
  const token=document.getElementById('regToken').value.trim();
  const ibu=document.getElementById('regIbu').value.trim();
  const errorBox=document.getElementById("regEmailError");
  errorBox.innerText="";

  if(!email||!pass||!token||!ibu){ alert("Lengkapi semua data!"); return; }
  if(!isValidEmail(email)){ errorBox.innerText="Format email tidak valid!"; return; }

  db.ref("panel/"+token).get().then(panelSnap=>{
    if(!panelSnap.exists()){ alert("âŒ Token panel tidak ditemukan!"); return; }

    const userId=email.replace(/\W/g,"_");
    db.ref("users/"+userId).get().then(snap=>{
      if(snap.exists()){ errorBox.innerText="Email sudah terpakai!"; }
      else {
        db.ref("users/"+userId).set({email,password:pass,token,ibu,isAdmin:false}).then(()=>{
          alert("âœ… Registrasi berhasil.");
          showPage("loginPage");
        });
      }
    });
  });
}

/* === LOGIN === */
function loginUser(){
  const email=document.getElementById('logEmail').value;
  const pass=document.getElementById('logPassword').value;
  const userId=email.replace(/\W/g,"_");

  db.ref("users/"+userId).get().then(snap=>{
    if(snap.exists()){
      const data=snap.val();
      if(data.password===pass){
        currentUser=email;
        currentToken=data.token;
        isAdmin=data.isAdmin||false;
        localStorage.setItem("iotUser", JSON.stringify({email:currentUser,token:currentToken,isAdmin}));
        updatePanelUI();
      } else alert("Password salah!");
    } else alert("User tidak ditemukan!");
  });
}

/* === SESSION PERSIST === */
window.addEventListener("load", ()=>{
  const session=JSON.parse(localStorage.getItem("iotUser"));
  if(session){
    currentUser=session.email;
    currentToken=session.token;
    isAdmin=session.isAdmin;
    updatePanelUI();
  } else showPage("loginPage");
});

/* === PANEL UI === */
function updatePanelUI(){
  document.getElementById("panelInfo").innerText="Login: "+currentUser+" | Token: "+currentToken+(isAdmin?" | Admin":"");
  document.getElementById("controllerTitle").innerText="âš¡ IoT Dashboard - "+currentToken;
  document.getElementById("panelTitle").innerText="Panel IoT - "+currentToken;
  showPage("panelPage");
  resetCharts(); setupCharts();
  listenPanel(); loadUsersByToken(); updateAdminUI();
}

/* === LOGOUT === */
function logout(){
  currentUser=null; currentToken=null; isAdmin=false;
  if(voltageChart) voltageChart.destroy();
  if(ampereChart) ampereChart.destroy();
  if(panelRef) panelRef.off();
  localStorage.removeItem("iotUser");
  showPage("loginPage");
}

/* === ADMIN UI === */
function updateAdminUI(){
  document.getElementById("btnOn").style.display=isAdmin?"inline-block":"none";
  document.getElementById("btnOff").style.display=isAdmin?"inline-block":"none";
  document.getElementById("userListTitle").style.display=isAdmin?"block":"none";
}

/* === PANEL LISTEN === */
function listenPanel(){
  if(panelRef) panelRef.off();
  panelRef=db.ref("panel/"+currentToken);
  panelRef.on("value", snap=>{
    const d=snap.val()||{};
    document.getElementById("voltageVal").innerText=d.voltage||0;
    document.getElementById("ampereVal").innerText=d.ampere||0;
    addData(voltageChart, voltageData, voltageLabels, d.voltage||0);
    addData(ampereChart, ampereData, ampereLabels, d.ampere||0);
  });
}

/* === SEND COMMAND === */
function sendCommand(cmd){
  if(currentToken && isAdmin){
    db.ref("panel/"+currentToken).update({status:cmd,updatedBy:currentUser,updatedAt:new Date().toLocaleString()});
  } else alert("Hanya admin yang bisa ON/OFF!");
}

/* === CHARTS === */
function resetCharts(){ voltageData=[]; voltageLabels=[]; ampereData=[]; ampereLabels=[]; if(voltageChart) voltageChart.destroy(); if(ampereChart) ampereChart.destroy(); }
function setupCharts(){
  voltageChart=new Chart(document.getElementById('voltageChart').getContext('2d'),{type:'line',
    data:{labels:voltageLabels,datasets:[{label:'Voltage',data:voltageData,borderColor:'#2575fc',backgroundColor:'rgba(37,117,252,0.2)',tension:0.3}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}});
  ampereChart=new Chart(document.getElementById('ampereChart').getContext('2d'),{type:'line',
    data:{labels:ampereLabels,datasets:[{label:'Ampere',data:ampereData,borderColor:'#ff9500',backgroundColor:'rgba(255,149,0,0.2)',tension:0.3}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}});
}
function addData(chart, dataArr, labelArr, value){
  const now=new Date().toLocaleTimeString();
  dataArr.push(value); labelArr.push(now);
  if(dataArr.length>10){ dataArr.shift(); labelArr.shift(); }
  chart.update();
}

/* === USER MANAGEMENT === */
function loadUsersByToken(){
  const listEl=document.getElementById("userList"); listEl.innerHTML="";
  if(!isAdmin) return;
  db.ref("users").get().then(snap=>{
    if(snap.exists()){
      const users=snap.val();
      for(const key in users){
        if(users[key].token===currentToken){
          const card=document.createElement("div");
          card.className="card";
          card.innerHTML=`<span>${users[key].email}${users[key].isAdmin?" (Admin)":""}</span>`;
          if(users[key].email!==currentUser){
            const delBtn=document.createElement("button");
            delBtn.className="btn-danger";
            delBtn.innerText="Hapus";
            delBtn.onclick=()=>deleteUser(users[key].email);
            card.appendChild(delBtn);
          }
          listEl.appendChild(card);
        }
      }
    }
  });
}
function deleteUser(email){
  if(confirm("Yakin hapus user: "+email+" ?")){
    const userId=email.replace(/\W/g,"_");
    db.ref("users/"+userId).remove().then(()=>{ alert("User dihapus!"); loadUsersByToken(); });
  }
}

/* === FORGOT PASSWORD === */
function forgotPassword(){
  const email=prompt("Masukkan email Anda:");
  const ibu=prompt("Masukkan nama ibu kandung:");
  const userId=email.replace(/\W/g,"_");
  db.ref("users/"+userId).get().then(snap=>{
    if(snap.exists()){
      const data=snap.val();
      if(data.ibu && data.ibu.toLowerCase()===ibu.toLowerCase()){
        const newPass=prompt("Jawaban benar. Masukkan password baru:");
        if(newPass) db.ref("users/"+userId+"/password").set(newPass).then(()=>alert("Password berhasil direset."));
      } else alert("Jawaban salah!");
    } else alert("User tidak ditemukan!");
  });
}
</script>
</body>
</html>
