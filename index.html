<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* === GLOBAL === */
body {
  font-family:"Segoe UI", Tahoma, sans-serif;
  background:linear-gradient(135deg,#6a11cb,#2575fc);
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
  color:#333;
}
.container {
  width:100%;
  max-width:950px;
  background:#fff;
  padding:30px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  animation:fadeIn 0.8s ease-in-out;
}
h2 { text-align:center; color:#6a11cb; margin-bottom:20px; }
h3 { color:#2575fc; text-align:center; margin-bottom:15px; }
input { width:100%; max-width:400px; padding:12px; margin:8px auto; border:1px solid #ddd; border-radius:10px; display:block; font-size:15px; transition:0.2s; }
input:focus { outline:none; border-color:#6a11cb; box-shadow:0 0 5px rgba(106,17,203,0.5); }
button { padding:10px 18px; margin:5px; border:none; border-radius:10px; font-size:15px; font-weight:bold; cursor:pointer; transition:all 0.3s ease; box-shadow:0 4px 8px rgba(0,0,0,0.15); }
.btn-primary { background:linear-gradient(135deg,#2575fc,#6a11cb); color:#fff; }
.btn-primary:hover { transform:translateY(-2px) scale(1.05); }
.btn-danger { background:#ff4d4d; color:#fff; }
.btn-danger:hover { transform:scale(1.05); }
a { color:#2575fc; cursor:pointer; text-decoration:none; }
a:hover { text-decoration:underline; }
.page { display:none; }
.active { display:block; }

/* === CARD GRID === */
.card-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
  margin:15px 0;
}
.card {
  background:#f8f9ff;
  padding:20px;
  border-radius:15px;
  text-align:center;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
  transition:0.3s;
}
.card:hover { transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,0.2); }
.card span { font-size:18px; font-weight:bold; color:#2575fc; display:block; margin-top:8px; }

canvas {
  background:#fff;
  border-radius:12px;
  padding:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
  margin-top:20px;
  width:100% !important;
  height:auto !important;
}
.btn-group { text-align:center; margin-top:20px; }
.error { color:red; font-size:13px; text-align:center; margin-bottom:8px; }
.footer { margin-top:20px; font-size:13px; color:#fff; text-align:center; }

/* === ANIMASI === */
@keyframes fadeIn {
  from { opacity:0; transform:translateY(-20px); }
  to { opacity:1; transform:translateY(0); }
}

/* === RESPONSIVE === */
@media (max-width:600px){
  .container { padding:20px; }
  h2 { font-size:1.6rem; }
  h3 { font-size:1.2rem; }
  button { font-size:14px; padding:8px 14px; }
}
</style>
</head>
<body>
<div class="container">
  <h2 id="controllerTitle">‚ö° IoT Dashboard</h2>

  <!-- REGISTER PAGE -->
  <div id="registerPage" class="page">
    <h3>Daftar Akun</h3>
    <input type="text" id="regEmail" placeholder="Email">
    <div id="regEmailError" class="error"></div>
    <input type="password" id="regPassword" placeholder="Password">
    <input type="text" id="regToken" placeholder="Token Panel">
    <input type="text" id="regIbu" placeholder="Nama Ibu Kandung">
    <div style="text-align:center;">
      <button class="btn-primary" onclick="registerUser()">Daftar</button>
    </div>
    <p style="text-align:center;">Sudah punya akun? <a onclick="showPage('loginPage')">Login</a></p>
  </div>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="page active">
    <h3>Login</h3>
    <input type="text" id="logEmail" placeholder="Email">
    <input type="password" id="logPassword" placeholder="Password">
    <div style="text-align:center;">
      <button class="btn-primary" onclick="loginUser()">Login</button>
    </div>
    <p style="text-align:center;">Belum punya akun? <a onclick="showPage('registerPage')">Daftar</a></p>
    <p style="text-align:center;"><a onclick="forgotPassword()">Lupa Password?</a></p>
  </div>

  <!-- PANEL PAGE -->
  <div id="panelPage" class="page">
    <h3 id="panelTitle">Panel IoT</h3>
    <p id="panelInfo" style="text-align:center;"></p>

    <div class="card-grid">
      <div class="card">Voltage<span id="voltageVal">0</span> V</div>
      <div class="card">Ampere<span id="ampereVal">0</span> A</div>
    </div>

    <h3 id="userListTitle" style="display:none;">Pengguna Token Ini</h3>
    <div id="userList" class="card-grid"></div>

    <canvas id="voltageChart"></canvas>
    <canvas id="ampereChart"></canvas>

    <div class="btn-group">
      <button id="btnOn" class="btn-primary" onclick="sendCommand('ON')">üîµ ON</button>
      <button id="btnOff" class="btn-primary" onclick="sendCommand('OFF')">‚ö™ OFF</button>
      <button class="btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="footer">Pembuat: miftahuddin wardani</div>
</div>

<script>
/* === FIREBASE CONFIG === */
const firebaseConfig = { databaseURL:"https://esp32-3a6dd-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* === GLOBAL VARIABLES === */
let currentUser=null, currentToken=null, isAdmin=false;
let voltageChart=null, ampereChart=null;
let voltageData=[], voltageLabels=[], ampereData=[], ampereLabels=[];
let panelRef=null;

/* === DEFAULT DEVELOPER === */
const defaultDevId="zaki5go".replace(/\W/g,"_");
db.ref("users/"+defaultDevId).get().then(snap=>{
  if(!snap.exists()){
    db.ref("users/"+defaultDevId).set({email:"zaki5go", password:"miftahuddin9", token:"developer", ibu:"default", isAdmin:true});
    db.ref("panel/developer").set({voltage:0, ampere:0, status:"OFF"});
  }
});

/* === PAGE SWITCH === */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* === VALIDASI EMAIL === */
function isValidEmail(email){ return email.includes('@') && email.includes('.'); }

/* === REGISTER === */
function registerUser(){
  const email = document.getElementById('regEmail').value.trim();
  const pass = document.getElementById('regPassword').value.trim();
  const token = document.getElementById('regToken').value.trim();
  const ibu = document.getElementById('regIbu').value.trim();
  const errorBox = document.getElementById("regEmailError");
  errorBox.innerText = "";

  if(!email || !pass || !token || !ibu){
    alert("Lengkapi semua data!");
    return;
  }
  if(!isValidEmail(email)){
    errorBox.innerText = "Format email tidak valid!";
    return;
  }

  // Cek token panel
  db.ref("panel/" + token).get().then(panelSnap => {
    if(!panelSnap.exists()){
      alert("‚ùå Token panel tidak ditemukan!");
      return;
    }

    const userId = email.replace(/\W/g, "_");
    db.ref("users/" + userId).get().then(snap => {
      if(snap.exists()){
        errorBox.innerText = "Email sudah terpakai!";
      } else {
        db.ref("users/" + userId).set({
          email: email,
          password: pass,
          token: token,
          ibu: ibu,
          isAdmin: false
        }).then(() => {
          alert("‚úÖ Registrasi berhasil. Silakan login.");
          showPage("loginPage");
        }).catch(err => {
          console.error(err);
          alert("‚ùå Terjadi kesalahan saat registrasi.");
        });
      }
    }).catch(err => {
      console.error(err);
      alert("‚ùå Gagal mengecek user di database.");
    });
  });
}

/* === LOGIN === */
function loginUser(){
  const email = document.getElementById('logEmail').value.trim();
  const pass = document.getElementById('logPassword').value.trim();
  if(!email || !pass){ alert("Isi email dan password!"); return; }

  const userId = email.replace(/\W/g, "_");
  db.ref("users/" + userId).get().then(snap => {
    if(snap.exists()){
      const data = snap.val();
      if(data.password === pass){
        currentUser = email;
        currentToken = data.token;
        isAdmin = data.isAdmin || false;
        showPage("panelPage");
        initPanel(currentToken);
      } else {
        alert("‚ùå Password salah!");
      }
    } else {
      alert("‚ùå User tidak ditemukan!");
    }
  });
}

/* === LOGOUT === */
function logout(){
  currentUser = null;
  currentToken = null;
  isAdmin = false;
  voltageData = [];
  voltageLabels = [];
  ampereData = [];
  ampereLabels = [];
  if(voltageChart) voltageChart.destroy();
  if(ampereChart) ampereChart.destroy();
  showPage("loginPage");
}

/* === PANEL INIT === */
function initPanel(token){
  panelRef = db.ref("panel/" + token);

  // Update data realtime
  panelRef.on("value", snap => {
    const data = snap.val();
    if(!data) return;

    // Update card
    document.getElementById("voltageVal").innerText = data.voltage || 0;
    document.getElementById("ampereVal").innerText = data.ampere || 0;
    document.getElementById("panelInfo").innerText = "Status: " + (data.status || "OFF");

    // Update chart
    const now = new Date().toLocaleTimeString();
    voltageData.push(data.voltage || 0);
    voltageLabels.push(now);
    ampereData.push(data.ampere || 0);
    ampereLabels.push(now);

    if(voltageData.length > 20){ voltageData.shift(); voltageLabels.shift(); }
    if(ampereData.length > 20){ ampereData.shift(); ampereLabels.shift(); }

    updateCharts();
  });

  // Tampilkan list user yang pakai token
  db.ref("users").orderByChild("token").equalTo(token).get().then(snap => {
    const users = snap.val();
    const userListDiv = document.getElementById("userList");
    userListDiv.innerHTML = "";
    if(users){
      document.getElementById("userListTitle").style.display = "block";
      Object.values(users).forEach(u=>{
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = u.email;
        userListDiv.appendChild(card);
      });
    }
  });
}

/* === UPDATE CHARTS === */
function updateCharts(){
  if(!voltageChart){
    const ctxV = document.getElementById("voltageChart").getContext("2d");
    voltageChart = new Chart(ctxV, {
      type:"line",
      data:{labels: voltageLabels, datasets:[{label:"Voltage (V)", data:voltageData, borderColor:"#2575fc", fill:false, tension:0.3}]},
      options:{responsive:true, animation:false, scales:{y:{beginAtZero:true}}}
    });
  } else {
    voltageChart.data.labels = voltageLabels;
    voltageChart.data.datasets[0].data = voltageData;
    voltageChart.update();
  }

  if(!ampereChart){
    const ctxA = document.getElementById("ampereChart").getContext("2d");
    ampereChart = new Chart(ctxA, {
      type:"line",
      data:{labels: ampereLabels, datasets:[{label:"Ampere (A)", data:ampereData, borderColor:"#6a11cb", fill:false, tension:0.3}]},
      options:{responsive:true, animation:false, scales:{y:{beginAtZero:true}}}
    });
  } else {
    ampereChart.data.labels = ampereLabels;
    ampereChart.data.datasets[0].data = ampereData;
    ampereChart.update();
  }
}

/* === SEND COMMAND === */
function sendCommand(cmd){
  if(!panelRef) return;
  panelRef.update({status: cmd});
  alert("‚úÖ Command " + cmd + " terkirim!");
}

/* === UTILITY === */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function isValidEmail(email){ return email.includes("@") && email.includes("."); }

function forgotPassword(){
  const email = prompt("Masukkan email untuk reset password:");
  if(!email){ alert("Email wajib diisi!"); return; }
  const userId = email.replace(/\W/g,"_");
  db.ref("users/"+userId).get().then(snap=>{
    if(snap.exists()){
      alert("Password Anda: " + snap.val().password);
    } else { alert("‚ùå User tidak ditemukan!"); }
  });
}
</script>
</body>
</html>
